<!-- For help on using this template, see the blog post: https://blog.mturk.com/editing-the-survey-link-project-template-in-the-ui-7c75285105fb#.py7towsdx -->
<!-- HIT template: SurveyLink-v3.0 -->
<!-- The following snippet enables the 'responsive' behavior on smaller screens -->
<meta content="width=device-width,initial-scale=1" name="viewport" />
<section class="container" id="SurveyContainer">
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="panel-body" id="instructionBody">
                <p>We are conducting an academic survey about workplace conditions.</p>

                <p>Please <strong>accept the HIT</strong> and then answer a few quick questions about yourself below. Then, if you'd like to do an <strong>additional 50 minute survey with roughly 30 multiple-choice questions and three 300-word essays</strong> for a <strong>bonus of <span class="bonus" id="bonusAmt1">(accept HIT to reveal bonus)</span></strong> on top of the $0.15 base pay, please answer <strong>&quot;Yes&quot;</strong> on the final question to proceed to the survey. The bonus will only be paid upon full completion of the survey, and wil bel checked for consistency and accuracy. Otherwise, to reject the offer and just receive the base pay of $0.15, click the blue <strong>&quot;Submit&quot;</strong> button at the bottom of the page.</p>

                <p>Whether or not you accept the bonus offer, <strong>you may not submit more than one HIT.</strong> Additional HIT requests will be rejected.</p>
            </div>
        </div>
    </div>

    <!-- Survey Link Layout -->

    <div class="row" id="workContent">
        <div class="col-xs-12 col-md-10 col-md-offset-1">
            <!-- Content for Worker -->
            <table class="table table-bordered">
                <colgroup>
                    <col class="col-xs-5 col-md-5" />
                    <col class="col-xs-7 col-md-7" />
                </colgroup>
                <tbody>
                    <tr id="ageTr">
                        <td><label for="age">Please enter your age, in years:</label></td>
                        <td><input class="form-control" id="age" name="age" required="" type="text" /></td>
                    </tr>
                    <tr id="onlineTr">
                        <td><label for="onlinehrs">Hours per week spent online doing tasks for money:</label></td>
                        <td><input class="form-control" id="onlinehrs" name="onlinehrs" type="text" /></td>
                    </tr>
                    <tr id="reasonTr">
                        <td><label for="reason">Primary reason for participation:</label></td>
                        <td><select class="form-control" id="reason" name="reason"><option disabled="disabled" hidden="" selected="selected" value="">-- Please select an option --</option><option value="money">Make money</option><option value="skills">Learn new skills</option><option value="fun">Have fun</option> </select></td>
                    </tr>
                    <tr id="offerTr">
                        <td id="nextLabel"><strong>Are you willing to fully complete an additional 50 minute survey, with roughly 30 multiple-choice questions and three short essays, for a bonus of <span class="bonus" id="bonusAmt2">(accept HIT to reveal amount)</span>?</strong></td>
                        <td id="nextButtonTd">
                            <input disabled="disabled" id="yesRadio" name="acceptOffer" type="radio" value="yes" /><label for="yesRadio">Yes</label><br />
                            <input disabled="disabled" id="noRadio" name="acceptOffer" type="radio" value="no" /><label for="noRadio">No</label>
                            <input type="hidden" name="generatedwage" id="generatedWageInput" />
                        </td>
                    </tr>
                    <tr id="finishSurveyTr" style="display:none;">
                        <td>&nbsp;</td>
                        <td>Thank you for completing the HIT. Please click the blue &quot;Submit&quot; button below to finish. Your submission will be approved within 24 hours.</td>
                    </tr>
                    <tr id="linkTr" style="display: none;">
                        <td id="linkLabelTd"><label for="surveyLink">Survey Link:</label></td>
                        <td id="linkTd"><a href="#" id="surveyLink">Click here to begin the survey</a></td>
                    </tr>
                    <tr id="codeTr" style="display: none;">
                        <td id="codeLabelTd"><label for="codeInput">Survey Completion Code:</label></td>
                        <td id="codeInputTd"><input id="codeInput" name="surveyCode" style="width: 100%;" type="text" /></td>
                    </tr>
                </tbody>
            </table>
            <!-- End Content for Worker -->
        </div>
    </div>

    <!-- End Survey Link Layout -->
</section>

<!-- Please note that Bootstrap CSS/JS and JQuery are 3rd party libraries that may update their url/code at any time. Amazon Mechanical Turk (MTurk) is including these libraries as a default option for you, but is not responsible for any changes to the external libraries -->

<!-- External CSS references -->
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" integrity="sha384-IS73LIqjtYesmURkDE9MXKbXqYA8rvKEp/ghicjem7Vc3mGRdQRptJSz60tvrB6+" rel="stylesheet" />

<!-- Open internal style sheet -->
<style type="text/css">
#collapseTrigger {
  color:#fff;
  display: block;
  text-decoration: none;
}
.image{
  margin-bottom: 15px; 
}
/* CSS for breaking long words/urls */
.dont-break-out {
  overflow-wrap: break-word;
  word-wrap: break-word;
  -ms-word-break: break-all;
  word-break: break-all;
  word-break: break-word;
  -ms-hyphens: auto;
  -moz-hyphens: auto;
  -webkit-hyphens: auto;
  hyphens: auto;
}
</style>
<!-- Close internal style sheet -->

<!-- External JS references -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" integrity="sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4" crossorigin="anonymous"></script>

<!-- Internal JS -->
<script>
$(document).ready(function() {
    var base_url = "https://cumc.co1.qualtrics.com/jfe/form/SV_4HFIB0U7Cx8l9C6";
    var which_exp = "01"; // can change to "full"
    // Fill in the bonus amt if they've accepted
    var param_str = window.location.search.substring(1);
    var param_pairs = param_str.split("&");
    var cur_mtid = "";
    for (i in param_pairs) {
        var cur_pair = param_pairs[i].split("=");
        if (cur_pair[0] == "workerId") {
            cur_mtid = cur_pair[1];
        }
    }
    console.log("cur_mtid: " + cur_mtid)
    if (cur_mtid != "" ) {
        $(".bonus").text("(Loading bonus...)");
        // Get the bonus amt for this worker
        // First check if their ID is in the DB
        var check_url = "https://jjacobs.info/user_in_db.php";
        console.log("Checking mtid " + cur_mtid);
        var is_in_db = false;
        var db_wage = "";
        var query_result = $.ajax({
            url: check_url,
            data: {'mtid': cur_mtid, "which_exp": which_exp},
            success: function (result) {
                console.log( "Query Result: " + result );
                if (result != "False") {
                    is_in_db = true;
                    db_wage = result;
                }
            },
            async: false
        });
        console.log("is_in_db? " + is_in_db);
        // Now add if it's not already in DB
        if (is_in_db) {
            $(".bonus").text(db_wage);
            $("#generatedWageInput").val(db_wage);
            $("#yesRadio").prop("disabled",false);
            $("#noRadio").prop("disabled",false);
            $("#surveyLink").attr("href",base_url + "?offer=" + db_wage + "&mt_id=" + cur_mtid + "&which_exp=" + which_exp);
            $("#surveyLink").attr("target","_blank");
        } else {
            var cur_timestamp = Date.now().toString();
            //var cur_mtid = turkGetParam("workerId");
            // Register the user
            var ajax_url = "https://jjacobs.info/register_restdb.php";
            console.log("register_restdb: mtid " + cur_mtid + ", timestamp " + cur_timestamp);
            $.ajax({
                url: ajax_url,
                data: {mtid: cur_mtid, timestamp: cur_timestamp, which_exp: which_exp},
                success: function (result) {
                    //$("loadAnim").hide();
                    console.log( "Post Result: " + result );
                    $(".bonus").text(result);
                    $("#generatedWageInput").val(result);
                    $("#yesRadio").prop("disabled",false);
                    $("#noRadio").prop("disabled",false);
                    $("#surveyLink").attr("href",base_url + "?offer=" + result + "&mt_id=" + cur_mtid + "&which_exp=" + which_exp);
                    $("#surveyLink").attr("target","_blank");
                    //return true;
                },
                async: false
            });
        }
    }
    var bonus_instr = `<p><strong>Thank you for accepting the bonus offer!</strong> At the end of the survey you will receive a code to paste into the box below to receive credit for successful completion of the bonus portion.</p>

<p><strong>Make sure to leave this window open as you complete the survey. </strong> When you are finished you will receive a survey completion code, and you must return to this page and paste this code into the box below to receive the HIT reward (along with any bonus amount earned for answering additional survey questions).</p>

<p>(Remember that <strong>you may not submit more than one HIT.</strong> Additional HIT requests will be rejected.)</p>

<p id="pleaseClick">Please click the link below to begin the survey.</p>`;

    $("#noRadio").click(function() {
      $("#offerTr").hide();
      $("#finishSurveyTr").show();
    });
    
    $("#yesRadio").click(function(){
        // Hide the questions they already answered
        //$("#ageTr").hide();
        //$("#onlineTr").hide();
        //$("#reasonTr").hide();
        //$("#nextTr").hide();
        // Just in case
        $("#finishSurveyTr").hide();
        $("#nextButtonTd").text("Thank you for accepting the offer!");
        // And show the new stuff
        $("#instructionBody").html(bonus_instr);
        $("#linkTr").show();
        $("#codeTr").show();
        return true;
    });
});
</script>
<!-- Close internal JS -->
