<!DOCTYPE html>
<html>
<head>
    <title>HIT Preview</title>
</head>
<body>
<!-- For help on using this template, see the blog post: https://blog.mturk.com/editing-the-survey-link-project-template-in-the-ui-7c75285105fb#.py7towsdx -->
<!-- HIT template: SurveyLink-v3.0 -->
<!-- The following snippet enables the 'responsive' behavior on smaller screens -->
<meta content="width=device-width,initial-scale=1" name="viewport" />
<section class="container" id="SurveyLink"><!-- Instructions -->
<div class="row" id="instructions">
<div class="col-xs-12 col-md-12">
<div class="panel panel-primary">
<div class="panel-heading"><strong>Survey Instructions</strong></div>

<div class="panel-body" id="instructionBody">
<p>We are conducting an academic survey about the conditions of the modern workplace. Before we begin, please <strong>accept the HIT</strong> and then answer a few quick questions about yourself below. Then, click on the survey link to proceed to the survey.</p>

<p>At the end of the survey you will receive a code to paste into the box below to receive credit for successful completion. <strong>You may not submit more than one HIT.</strong> Additional HIT requests will be rejected.</p>

<p><strong>Make sure to leave this window open as you complete the survey. </strong> When you are finished, return to this page and paste the survey completion code into the box below to receive the HIT reward.</p>
</div>
</div>
</div>
</div>
<!-- End Instructions --><!-- Survey Link Layout 1 -->

<div class="row" id="workContent1">
<div class="col-xs-12 col-md-6 col-md-offset-3"><!-- Content for Worker -->
<table class="table table-condensed table-bordered">
	<colgroup>
		<col class="col-xs-4 col-md-4" />
		<col class="col-xs-8 col-md-8" />
	</colgroup>
	<tbody>
		<tr>
			<td><label for="age">Please enter your age, in years:</label></td>
			<td><input class="form-control" id="age" name="age" required="" type="text" /></td>
		</tr>
		<tr>
			<td><label for="onlinehrs">Hours per week spent online doing tasks for money:</label></td>
			<td><input class="form-control" id="onlinehrs" name="onlinehrs" type="text" /></td>
		</tr>
		<tr>
			<td><label for="reason">Primary reason for participation:</label></td>
			<td>
                <select class="form-control" id="reason" name="reason">
                <option disabled="disabled" hidden="" selected="selected" value="">-- Please select an option --</option>
                <option value="money">Make money</option>
                <option value="skills">Learn new skills</option>
                <option value="fun">Have fun</option>
                </select>
            </td>
		</tr>
		<tr>
			<td><label for="bonusAmt">Bonus for completing survey:</label></td>
			<td><div id="bonusAmt">(Please <strong>accept the HIT</strong> to reveal the survey completion bonus)</div></td>
		</tr>
		<tr>
			<td><label>Survey link:</label></td>
			<td><a class="dont-break-out" href="#">(Please <strong>accept the HIT</strong> to reveal the survey link)</a></td>
		</tr>
	</tbody>
</table>
<!-- End Content for Worker --><!-- Input from Worker -->

<div class="form-group">
    <label for="surveycode">When you&#39;re finished, provide the survey code here, then click the &quot;Submit&quot; button below:</label>
    <input class="form-control" id="surveycode" name="surveycode" placeholder="e.g. 0123456789" required="" type="text" />
</div>
<!-- End input from Worker -->
</div>
</div>
<!-- End Survey Link Layout --></section>
<!-- Please note that Bootstrap CSS/JS and JQuery are 3rd party libraries that may update their url/code at any time. Amazon Mechanical Turk (MTurk) is including these libraries as a default option for you, but is not responsible for any changes to the external libraries --><!-- External CSS references -->
<link crossorigin="anonymous" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" integrity="sha384-IS73LIqjtYesmURkDE9MXKbXqYA8rvKEp/ghicjem7Vc3mGRdQRptJSz60tvrB6+" rel="stylesheet" /><!-- Open internal style sheet -->
<style type="text/css">.image {
  margin-bottom: 15px; 
}
/* CSS for breaking long words/urls */
.dont-break-out {
  overflow-wrap: break-word;
  word-wrap: break-word;
  -ms-word-break: break-all;
  word-break: break-all;
  word-break: break-word;
  -ms-hyphens: auto;
  -moz-hyphens: auto;
  -webkit-hyphens: auto;
  hyphens: auto;
}
</style>
<!-- Close internal style sheet -->
<!-- External JS references -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js"   integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="   crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js" integrity="sha384-s1ITto93iSMDxlp/79qhWHi+LsIi9Gx6yL+cOKDuymvihkfol83TYbLbOw+W/wv4" crossorigin="anonymous"></script>
<!-- Open internal javascript -->
<script>
$(document).ready(function() {
    var base_url = "https://cumc.co1.qualtrics.com/jfe/form/SV_23rt63LqW5YhJye";
    function idToWage(dbId) {
        var wages = ['$0.50', '$0.90', '$0.95', '$0.98', '$0.99', '$1.00',
                      '$1.01', '$1.02', '$1.05', '$1.10', '$1.50'];
        var index = dbId % wages.length;
        return wages[index];
    }
    var paramstr = window.location.search.substring(1);
    var parampairs = paramstr.split("&");
    var cur_mtid = "";
    for (i in parampairs) {
        var pair = parampairs[i].split("=");
        if (pair[0] == "workerId")
        cur_mtid = pair[1];
    }
    if (cur_mtid != "" ) {
        $("#loadAnim").show();
        // First check if it's in the DB
        var checkUrl = "https://jjacobs.info/user_in_db.php";
        console.log("Checking mtid " + cur_mtid);
        var isInDB = false;
        var inDBWage = "";
        var queryResult = $.ajax({
            url: checkUrl,
            data: {'mtid':cur_mtid},
            success: function (result) {
                console.log( "Query Result: " + result );
                if (result != "False") {
                    isInDB = true;
                    inDBWage = result;
                }
            },
            async: false
        });
        console.log("isInDB? " + isInDB);
        // Now add if it's not already in DB
        if (isInDB) {
            $("#loadAnim").hide();
            var wageForId = idToWage(inDBWage);
            $("#resultDiv").text(wageForId);
            $("#surveyLink").attr("href","?offer=" + wageForId + "&mt_id=" + cur_mtid);
        } else {
            var cur_timestamp = Date.now().toString();
            //var cur_mtid = turkGetParam("workerId");
            // Register the user
            var ajaxUrl = "https://jjacobs.info/register_restdb.php";
            console.log("register_restdb: mtid " + cur_mtid + ", timestamp " + cur_timestamp);
            $.ajax({
                url: ajaxUrl,
                data: {mtid: cur_mtid, timestamp: cur_timestamp},
                success: function (result) {
                    $("loadAnim").hide();
                    console.log( "Post Result: " + result );
                    var wageForId = idToWage(result);
                    $("#bonusAmt").text(wageForId);
                    $("#surveyLink").attr("href",base_url + "?offer=" + wageForId + "&mt_id=" + cur_mtid);
                    $("#surveyLink").attr("target","_blank");
                    //return true;
                },
                async: false
            });
        }
    }
});
</script>
<!-- Close internal javascript -->
</body>
</html>